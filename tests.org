* ase + Vasp



#+BEGIN_SRC python
from ase import Atoms, Atom
from vasp import Vasp

import os
os.environ['ASE_VASP_COMMAND'] = '/home-research/zhongnanxu/opt/vasp-5.3.5/bin/vasp-vtst-beef-serial'

co = Atoms([Atom('C',[0,   0, 0]),
            Atom('O',[1.2, 0, 0])],
            cell=(6., 6., 6.))

calc = Vasp('molecules/simple-co', #output dir
          xc='PBE',  # the exchange-correlation functional
          nbands=6,  # number of bands
          encut=350, # planewave cutoff
          ismear=1,  # Methfessel-Paxton smearing
          sigma=0.01,# very small smearing factor for a molecule
          atoms=co)

calc.set(ispin=1)
co[0].position=[2, 0, 0]
co.cell=[4, 4, 4]
print calc.get_potential_energy()

#print a.get_magnetic_moments()
#+END_SRC

#+RESULTS:
#+begin_example
 vasp.5.3.5 31Mar14 (build Aug 04 2015 12:48:45) complex                        
  
 POSCAR found :  2 types and       2 ions
 LDA part: xc-table for Pade appr. of Perdew
 POSCAR found :  2 types and       2 ions
 POSCAR, INCAR and KPOINTS ok, starting setup
 WARNING: small aliasing (wrap around) errors must be expected
 FFT: planning ...
 WAVECAR not read
 WARNING: random wavefunctions but no delay for mixing, default for NELMDL
 entering main loop
       N       E                     dE             d eps       ncg     rms          rms(c)
DAV:   1     0.632077036032E+02    0.63208E+02   -0.28209E+03    12   0.851E+02
DAV:   2    -0.519599844869E+01   -0.68404E+02   -0.68404E+02    18   0.240E+02
DAV:   3    -0.148556863980E+02   -0.96597E+01   -0.96597E+01    12   0.977E+01
DAV:   4    -0.152887386122E+02   -0.43305E+00   -0.43363E+00    24   0.160E+01
DAV:   5    -0.152899193760E+02   -0.11808E-02   -0.60097E-03    12   0.768E-01    0.615E+00
DAV:   6    -0.148236994065E+02    0.46622E+00   -0.36356E+00    12   0.186E+01    0.351E+00
DAV:   7    -0.147229862382E+02    0.10071E+00   -0.57723E-01    18   0.782E+00    0.187E+00
DAV:   8    -0.146888623567E+02    0.34124E-01   -0.12153E-01    12   0.386E+00    0.354E-01
DAV:   9    -0.146894442467E+02   -0.58189E-03   -0.18638E-02    18   0.130E+00    0.159E-01
DAV:  10    -0.146898345993E+02   -0.39035E-03   -0.29007E-03    12   0.559E-01    0.349E-02
DAV:  11    -0.146907869258E+02   -0.95233E-03   -0.24248E-04     6   0.187E-01    0.159E-02
DAV:  12    -0.146910295726E+02   -0.24265E-03   -0.81263E-05     6   0.853E-02    0.925E-03
DAV:  13    -0.146911150690E+02   -0.85496E-04   -0.43040E-05     6   0.710E-02
   1 F= -.14691115E+02 E0= -.14691115E+02  d E =0.344033E-11
-14.69111507
#+end_example

* archive
** stuff

#+BEGIN_SRC python
from vasp import *

calc = Vasp('simple-co',
            encut=400,
            xc='beef-vdw',
            setups={'H': '_sv'},
            ldaul=(-1, 2),
            ldauu=[0, 0.2],
            ldauj=[0, 0.00],  kpts=(10, 10, 10))

# print dir(calc)
print calc.parameters
#print calc.special_kwargs
#print list(set(calc.parameters) - set(calc.special_kwargs))
#print {key: calc.parameters[key] for key in list(set(calc.parameters) - set(calc.special_kwargs))}
#calc.write_input(None)

#print open('simple-co/INCAR').read()

#print open('simple-co/KPOINTS').read()
#+END_SRC

#+RESULTS:
: {'kpts': (10, 10, 10), 'lcharge': False, 'xc': 'beef-vdw', 'ldaul': (-1, 2), 'ldauj': [0, 0.0], 'encut': 400, 'ldauu': [0, 0.2], 'gga': 'BF', 'zab_vdw': -1.8867, 'setups': {'H': '_sv'}, 'lwave': False, 'sigma': 0.1, 'luse_vdw': True}

#+BEGIN_SRC python
from vasp import *
from ase import Atom, Atoms

atoms = Atoms([Atom('O', [4, 4.5, 5], magmom=2),
               Atom('O', [4, 4.5, 5], magmom=2),
               Atom('H', [4, 4.5, 15], magmom=2),
               Atom('O', [4, 4.5, 25], magmom=2)],
              cell=(8, 9, 10))

calc = Vasp('molecules/O-sp-triplet-lowsym-sv',
          xc='pbe',
          ismear=0,
          ispin=2,
          sigma=0.01,
          setups={0: 'O_pv', 'O':'_sv'},
          atoms=atoms)


#+END_SRC

#+RESULTS:

I should get this.
: ['potpawPBE/O_pv/POTCAR', 'potpawPBE/O_sv/POTCAR', 'potpawPBE/H/POTCAR']


** Handling setups.
In VASP we have to create the POTCAR file by concatenating existing POTCAR files for each atom into a single file. There are several options for how to do this.

1. Each atom can have its own POTCAR.
2. Common atoms can be grouped to share a POTCAR




#+BEGIN_SRC python
from vasp import *
from ase import Atom, Atoms

atoms = Atoms([Atom('O', [4, 4.5, 5], magmom=2),
               Atom('O', [4, 4.5, 5], magmom=2),
               Atom('H', [4, 4.5, 15], magmom=2),
               Atom('O', [4, 4.5, 25], magmom=2)],
              cell=(8, 9, 10))

setups = [[3, '_pv'], ['O', '_sv']]

pp = 'PBE'

# goal:
# pp = [(3 ,'potpawPBE/O_pv/POTCAR', 1)
#       ('O', 'potpawPBE/O_sv/POTCAR', 2),
#       ('H', 'potpawPBE/H/POTCAR', 1)]
# sort_indices = [3, 0, 1, 2]
ppp = []
sort_indices = []

# First the numeric setups
for setup in [x for x in setups if isinstance(x[0], int)]:
    ppp += [[setup[0],
             'potpaw_{}/{}{}/POTCAR'.format(pp, atoms[setup[0]].symbol, setup[1]),
             1]]
    sort_indices += [setup[0]]

# now the rest of the setups. These are atom symbols
for setup in [x for x in setups if not isinstance(x[0], int)]:
    symbol = setup[0]
    count = 0
    for i, atom in enumerate(atoms):
        if atom.symbol == symbol and i not in sort_indices:
            count += 1
            sort_indices += [i]
    ppp += [[atom.symbol,
             'potpaw_{}/{}{}/POTCAR'.format(pp, symbol, setup[1]),
             count]]

# now the remaining atoms use default potentials
symbols = []
for atom in atoms:
    if atom.symbol not in symbols and atom.symbol not in [x[0] for x in pp]:
        symbols += [atom.symbol]

for symbol in symbols:
    count = 0
    for i, atom in enumerate(atoms):
        if atom.symbol == symbol and i not in sort_indices:
            sort_indices += [i]
            count += 1
    ppp += [[symbol,
             'potpaw_{}/{}/POTCAR'.format(pp, symbol),
             count]]


print symbols
print ppp
print sort_indices


#+END_SRC

#+RESULTS:
: ['O', 'H']
: [[3, 'potpaw_PBE/O_pv/POTCAR', 1], ['O', 'potpaw_PBE/O_sv/POTCAR', 2], ['O', 'potpaw_PBE/O/POTCAR', 0], ['H', 'potpaw_PBE/H/POTCAR', 1]]
: [3, 0, 1, 2]


#+BEGIN_SRC python
from vasp import Vasp
from ase import Atom, Atoms

atoms = Atoms([Atom('O', [4, 4.5, 0], magmom=2),
               Atom('O', [4, 4.5, 1], magmom=2),
               Atom('H', [4, 4.5, 2], magmom=2),
               Atom('O', [4, 4.5, 3], magmom=2)],
              cell=(8, 9, 10))

calc = Vasp('molecules/O-sp-triplet-lowsym-sv',
          xc='pbe',
          ismear=0,
          ispin=2,
          sigma=0.01,
          setups=[[1, '_h'], ['O', '_sv']],
          atoms=atoms)

print calc.sort_indices
print calc.ppp_list
#print calc.atoms_sorted
#print calc.symbol_count

calc.write_poscar('POSCAR')
calc.write_potcar('POTCAR')
#+END_SRC

#+RESULTS:
: [1, 0, 3, 2]
: [[1, 'potpaw_PBE/O_h/POTCAR', 1], ['O', 'potpaw_PBE/O_sv/POTCAR', 2], ['H', 'potpaw_PBE/H/POTCAR', 1]]

#+BEGIN_SRC sh
grep TITEL POTCAR
#+END_SRC

#+RESULTS:
:    TITEL  = PAW_PBE O_h 06Feb2004
:    TITEL  = PAW_PBE O_sv 05Jul2007
:    TITEL  = PAW_PBE H 15Jun2001

#+BEGIN_SRC python
import vasp
print vasp.__file__
print dir(vasp)
print vasp.Vasp
#+END_SRC

#+RESULTS:
: ['Calculator', 'FileIOCalculator', 'Vasp', '__builtins__', '__doc__', '__file__', '__name__', '__package__', 'np', 'os']
: vasp/__init__.pyc
: ['Vasp', '__builtins__', '__doc__', '__file__', '__name__', '__package__', '__path__', 'monkeypatch', 'vasp', 'writers']
: vasp.vasp.Vasp

** spin pol

#+BEGIN_SRC python
from vasp import Vasp
from ase import Atom, Atoms

atoms = Atoms([Atom('O', [5, 5, 5], magmom=2), Atom('H', [0, 0 ,0])],
              cell=(10, 10, 10))

calc = Vasp('molecules/O-sp-triplet',
            xc='PBE',
            encut=400,
            ismear=0,
            ispin=2,  # turn spin-polarization on
            atoms=atoms)

calc.write_incar('INCAR')
print open('INCAR').read()

#+END_SRC

#+RESULTS:
: INCAR created by Atomic Simulation Environment
:  MAGMOMS = 2.0 0.0
:  LCHARGE = .FALSE.
:  ENCUT = 400
:  ISPIN = 2
:  ISMEAR = 0
:  LWAVE = .FALSE.
:  SIGMA = 0.1
:

#+BEGIN_SRC python
from vasp import Vasp
from ase import Atom, Atoms

atoms = Atoms([Atom('O', [5, 5, 5], magmom=2), Atom('H', [0, 0 ,0])],
              cell=(10, 10, 10))

calc = Vasp('molecules/O-sp-triplet',
            xc='PBE',
            encut=400,
            ismear=0,
            magmoms=[2, -2],
            ispin=2,  # turn spin-polarization on
            atoms=atoms)

calc.write_incar('INCAR')
print open('INCAR').read()

#+END_SRC

#+RESULTS:
: INCAR created by Atomic Simulation Environment
:  MAGMOMS = 2 -2
:  LCHARGE = .FALSE.
:  ENCUT = 400
:  ISPIN = 2
:  ISMEAR = 0
:  LWAVE = .FALSE.
:  SIGMA = 0.1
:

** DFT+u
#+BEGIN_SRC python
from vasp import Vasp
from ase import Atom, Atoms

a = 4.27

atoms = Atoms([Atom('Cu',[0,0,0]),
               Atom('Cu',[0.5, 0.5, 0.0]),
               Atom('Cu',[0.5, 0.0, 0.5]),
               Atom('Cu',[0.0, 0.5, 0.5]),
               Atom('O',[0.25, 0.25, 0.25]),
               Atom('O',[0.75, 0.75, 0.75])])

atoms.set_cell((a,a,a), scale_atoms=True)

calc =Vasp('Cu2O-U=4.0',
             ldau=True,   # turn DFT+U on
             ldautype=2,  # select simplified rotationally invariant option
             ldau_luj={'Cu':{'L':2,  'U':4.0, 'J':0.0},
                        'O':{'L':-1, 'U':0.0, 'J':0.0}},
             ldauprint=1,
             ibrion=-1,  #do not rerelax
             nsw=0, atoms=atoms)

calc.write_incar('INCAR')
calc.write_poscar('POSCAR')

print calc.ppp_list
print open('INCAR').read()
print open('POSCAR').read()

#+END_SRC

#+RESULTS:
#+begin_example
[['Cu', 'potpaw_PBE/Cu/POTCAR', 4], ['O', 'potpaw_PBE/O/POTCAR', 2]]
INCAR created by Atomic Simulation Environment
 LCHARGE = .FALSE.
 LDAUL = 2 -1
 LDAUU = 4.0 0.0
 LDAUTYPE = 2
 LDAUJ = 0.0 0.0
 LDAU = .TRUE.
 IBRION = -1
 ISMEAR = 1
 LWAVE = .FALSE.
 SIGMA = 0.1
 LDAUPRINT = 1
 NSW = 0

Cu  O
 1.0000000000000000
     4.2699999999999996    0.0000000000000000    0.0000000000000000
     0.0000000000000000    4.2699999999999996    0.0000000000000000
     0.0000000000000000    0.0000000000000000    4.2699999999999996
   4   2
Cartesian
  0.0000000000000000  0.0000000000000000  0.0000000000000000
  2.1349999999999998  2.1349999999999998  0.0000000000000000
  2.1349999999999998  0.0000000000000000  2.1349999999999998
  0.0000000000000000  2.1349999999999998  2.1349999999999998
  1.0674999999999999  1.0674999999999999  1.0674999999999999
  3.2024999999999997  3.2024999999999997  3.2024999999999997

#+end_example

 LDAUL = -1 2
 LDAUU = 0.000 4.000
 LDAUJ = 0.000 0.000


** Idea for validation

#+BEGIN_SRC python
class Float(object):
    def __init__(self, val):
        self.val = val
        assert isinstance(val, float), '{} is not a float'.format(val)

    def __str__(self):
        return '{} = {}'.format(self.__class__.__name__.upper(), self.val)

class INCAR:
    file = 'INCAR'

class sigma(Float, INCAR):
    """SIGMA determines the width of the smearing in eV."""
    pass

print sigma(0.4)  # this is what would get written
print sigma.file  # this is where it would get written
print sigma.__doc__
#+END_SRC

#+RESULTS:
: SIGMA = 0.4
: INCAR
: SIGMA determines the width of the smearing in eV.
